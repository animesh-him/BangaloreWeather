<!doctype html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Weather Forecast</title>

<!-- Leaflet + Chart.js + html2canvas -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<style>
  /* base + theme */
  *,*::before,*::after{box-sizing:border-box}
  :root{
    --bg-from:#071017; --bg-to:#081424; --text:#e6eef6; --muted:#9aa6b2;
    --card:#0f1720; --accent:#ff6b6b; --ok:#66e08b; --panel:rgba(255,255,255,0.03);
    --border:rgba(255,255,255,0.06); --gap:12px;
  }
  [data-theme="light"]{
    --bg-from:#f7f9fc; --bg-to:#f4f6f9; --text:#07101a; --muted:#556070;
    --card:#fff; --accent:#b22222; --ok:#2e7d32; --panel:rgba(0,0,0,0.02); --border:rgba(16,24,40,0.05);
  }

  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg-from),var(--bg-to));font-family:Inter,system-ui,Roboto,Arial;color:var(--text);-webkit-font-smoothing:antialiased}
  .wrap{max-width:980px;margin:8px auto;padding:10px}
  header{display:flex;gap:var(--gap);align-items:center;flex-wrap:wrap}
  h1{margin:0;font-size:20px;color:var(--accent)}
  .subtitle{font-size:13px;color:var(--muted)}
  .controls{margin-left:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap}

  select,input,button{padding:8px 10px;border-radius:10px;border:1px solid var(--panel);background:var(--card);color:var(--text);font-size:13px}
  .mini{padding:6px 8px;font-size:13px;border-radius:8px}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:var(--gap);margin-top:12px}
  @media(max-width:920px){ .grid{grid-template-columns:1fr} }

  .card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 6px 20px rgba(0,0,0,0.35);color:var(--text);overflow:hidden}
  .row{display:flex;gap:10px;align-items:center}
  .small{font-size:13px;color:var(--muted)}
  .muted{color:var(--muted)}
  .hl{font-weight:700}

  /* TOP layout: left temp block + right summary + hourly row */
  .top-grid{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .temp-block{display:flex;align-items:center;gap:12px;min-width:220px}
  .temp-left,.temp-right{font-size:14px;color:var(--muted);text-align:center}
  .temp-left .label,.temp-right .label{font-size:12px;color:var(--muted)}
  .temp-center{font-size:40px;font-weight:800;line-height:1;text-align:center;min-width:120px}
  .summary-block{display:flex;align-items:center;gap:10px;min-width:220px}
  .summary-icon{font-size:36px}
  .summary-text{font-weight:800;color:var(--text);font-size:14px;max-width:320px}

  /* hourly icons row */
  .hourly-row{display:flex;gap:8px;align-items:center;overflow-x:auto;padding:8px 4px;margin-top:8px}
  .hourly-tile{min-width:72px;padding:8px;border-radius:8px;text-align:center;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);cursor:pointer;border:1px solid rgba(255,255,255,0.02)}
  .hourly-tile.selected{outline:2px solid rgba(255,255,255,0.06);transform:translateY(-4px)}
  .hourly-time{font-size:12px;color:var(--muted)}
  .hourly-icon{font-size:20px;margin-top:4px}
  .hourly-temp{font-size:13px;margin-top:4px;font-weight:700}

  /* charts and days */
  .charts{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
  canvas{width:100% !important;height:200px !important;display:block}
  .day-cards{display:flex;gap:8px;margin-top:12px;overflow:auto;padding-bottom:6px}
  .day-card{min-width:94px;padding:8px;border-radius:10px;text-align:center;cursor:pointer;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border:1px solid rgba(255,255,255,0.02)}
  .day-card.selected{outline:2px solid rgba(255,255,255,0.06);transform:translateY(-4px)}

  #map{height:150px;border-radius:10px;margin-top:12px;border:1px solid var(--border)}
  .coord{font-size:12px;color:var(--muted);margin-top:6px}

  /* ensure no horizontal scrollbar at initial load */
  @media (max-width:420px){
    .temp-center{font-size:34px;min-width:96px}
    .summary-text{font-size:13px}
    .hourly-tile{min-width:64px}
  }
</style>
</head>
<body>
  <div class="wrap" id="appRoot">
    <header>
      <div>
        <h1>Weather Forecast</h1>
        <div class="subtitle">Hourly ‚Ä¢ 12-hour chart ‚Ä¢ 5-day overview ‚Äî Open-Meteo (free)</div>
      </div>

      <div class="controls" role="group" aria-label="controls">
        <select id="preset" class="mini">
          <option value="">Presets (Bengaluru)</option>
          <option data-lat="13.128893" data-lon="77.649531">Aerospace Park</option>
          <option data-lat="12.9352" data-lon="77.6245">Koramangala</option>
          <option data-lat="13.0358" data-lon="77.5970">Hebbal</option>
          <option data-lat="12.9699" data-lon="77.7499">Whitefield</option>
          <option data-lat="12.8386" data-lon="77.6771">Electronic City</option>
        </select>
        <input id="searchBox" placeholder="Search city / place" style="min-width:120px"/>
        <button id="searchBtn" class="mini">Search</button>
        <button id="themeBtn" class="mini">üåì</button>
      </div>
    </header>

    <main class="grid" role="main">
      <!-- LEFT COLUMN -->
      <section>
        <div class="card" id="topCard">
          <div class="top-grid">
            <div class="temp-block" aria-hidden="false">
              <div class="temp-left">
                <div class="label">Low</div>
                <div id="lowTemp" class="hl">--¬∞</div>
              </div>

              <div class="temp-center" id="currentTemp">--¬∞</div>

              <div class="temp-right">
                <div class="label">High</div>
                <div id="highTemp" class="hl">--¬∞</div>
              </div>
            </div>

            <div class="summary-block" style="margin-left:auto">
              <div class="summary-icon" id="dayIcon">‚òÄÔ∏è</div>
              <div class="summary-text" id="daySummary">Loading summary‚Ä¶</div>
            </div>
          </div>

          <div class="hourly-row" id="hourlyRow" aria-live="polite" role="list"></div>
        </div>

        <div class="card" style="margin-top:12px">
          <div style="font-weight:700">Next 12 hours ‚Äî Temperature</div>
          <canvas id="tempChart"></canvas>
        </div>

        <div class="card" style="margin-top:12px">
          <div style="font-weight:700">Precipitation probability (%)</div>
          <canvas id="precipChart"></canvas>
        </div>

        <div class="card" style="margin-top:12px">
          <div style="font-weight:700">5-Day Overview</div>
          <div class="day-cards" id="dayCards" aria-live="polite"></div>
          <div id="dayDetail" style="margin-top:12px"></div>
        </div>
      </section>

      <!-- RIGHT COLUMN -->
      <aside>
        <div class="card">
          <div style="font-weight:700">Location</div>
          <div style="margin-top:8px">
            <div id="locName" class="hl">Aerospace Park</div>
            <div id="coords" class="coord">Lat: 13.128893 ‚Ä¢ Lon: 77.649531</div>
          </div>

          <div style="margin-top:10px">
            <div style="font-weight:700">Map</div>
            <div id="map"></div>
            <div id="mapCoords" class="coord">‚Äî</div>
          </div>

          <div style="margin-top:10px;display:flex;gap:8px">
            <input id="latInput" placeholder="lat" style="width:120px"/>
            <input id="lonInput" placeholder="lon" style="width:120px"/>
          </div>
          <div style="margin-top:8px;display:flex;gap:8px">
            <button id="setCoords" class="mini">Set coords</button>
            <button id="myLoc" class="mini">Use my location</button>
            <button id="snapshot" class="mini">üì∑ Snapshot</button>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div style="font-weight:700">Info</div>
          <div class="small muted" style="margin-top:8px">Data from Open-Meteo (free). Click an hourly tile to highlight it. The top shows Current / High / Low and today's summary.</div>
        </div>
      </aside>
    </main>
  </div>

<script>
/* ---------- config ---------- */
const DEFAULT = { name: "Aerospace Park", lat: 13.128893, lon: 77.649531 };
const OPEN_METEO = "https://api.open-meteo.com/v1/forecast";
const GEO = "https://geocoding-api.open-meteo.com/v1/search?name=";
const el = id => document.getElementById(id);

/* ---------- small helpers ---------- */
function clamp(v,a,b){return Math.max(a,Math.min(b,v))}
function formatTime(iso){ try { return new Date(iso).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); } catch(e){ return iso } }
function nowLocale(){ return new Date().toLocaleString() }

/* ---------- default theme ---------- */
const root = document.documentElement;
if(localStorage.getItem('theme')==='light') root.setAttribute('data-theme','light'); else root.setAttribute('data-theme','dark');
el('themeBtn').addEventListener('click', ()=>{ if(root.getAttribute('data-theme')==='dark'){ root.setAttribute('data-theme','light'); localStorage.setItem('theme','light') } else { root.removeAttribute('data-theme'); localStorage.setItem('theme','dark') } });

/* ---------- map setup ---------- */
const map = L.map('map', {center:[DEFAULT.lat, DEFAULT.lon], zoom:13, attributionControl:false});
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
let marker = L.marker([DEFAULT.lat, DEFAULT.lon], {draggable:true}).addTo(map).bindPopup(DEFAULT.name).openPopup();
marker.on('dragend', ()=>{ const p = marker.getLatLng(); loadAll(p.lat, p.lng, `Lat:${p.lat.toFixed(6)}, Lon:${p.lng.toFixed(6)}`); });
function centerMap(lat, lon, label){
  marker.setLatLng([lat,lon]); marker.bindPopup(label||'').openPopup();
  map.setView([lat,lon], 13);
  setTimeout(()=> map.invalidateSize(), 250);
  setTimeout(()=> map.invalidateSize(), 700);
  el('mapCoords').innerText = `Lat: ${lat.toFixed(6)}, Lon: ${lon.toFixed(6)}`;
  el('coords').innerText = `Lat: ${lat.toFixed(6)} ‚Ä¢ Lon: ${lon.toFixed(6)}`;
  el('latInput').value = lat.toFixed(6); el('lonInput').value = lon.toFixed(6);
}

/* ---------- charts ---------- */
const tempCtx = el('tempChart').getContext('2d'), precipCtx = el('precipChart').getContext('2d');
const tempChart = new Chart(tempCtx, { type:'line', data:{labels:[], datasets:[{label:'Temp', data:[], borderColor:'#ff8a65', backgroundColor:'rgba(255,138,101,0.12)', tension:0.25, pointRadius:4}]}, options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}} });
const precipChart = new Chart(precipCtx, { type:'bar', data:{labels:[], datasets:[{label:'Rain %', data:[], backgroundColor:'rgba(69,170,242,0.75)'}]}, options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true,max:100}},plugins:{legend:{display:false}}} });

/* ---------- weathercode mapping (basic emoji) ---------- */
const weatherMap = {0:'‚òÄÔ∏è',1:'üå§Ô∏è',2:'‚õÖ',3:'‚òÅÔ∏è',45:'üå´Ô∏è',48:'üå´Ô∏è',51:'üå¶Ô∏è',53:'üå¶Ô∏è',55:'üåßÔ∏è',61:'üåßÔ∏è',63:'üåßÔ∏è',65:'‚õàÔ∏è',80:'üå¶Ô∏è',81:'üåßÔ∏è',82:'‚õàÔ∏è',95:'‚õàÔ∏è',96:'‚õàÔ∏è'};
function wcIcon(code){ return weatherMap[code] || '‚ùì' }

/* ---------- nearest hourly index ---------- */
function nearestIndexToNow(times){
  if(!times || !times.length) return 0;
  const now = Date.now(); let best=0,bestDiff=Infinity;
  for(let i=0;i<times.length;i++){ const t = Date.parse(times[i]); if(isNaN(t)) continue; const d = Math.abs(t-now); if(d<bestDiff){ best=i; bestDiff=d } }
  return best;
}

/* ---------- open-meteo fetch ---------- */
async function fetchOpenMeteo(lat, lon){
  const params = new URLSearchParams({
    latitude: lat, longitude: lon,
    hourly: 'temperature_2m,precipitation_probability,weathercode',
    daily: 'temperature_2m_max,temperature_2m_min,weathercode,precipitation_sum',
    timezone: 'auto'
  });
  const url = OPEN_METEO + '?' + params.toString();
  const r = await fetch(url); if(!r.ok) throw new Error('Open-Meteo ' + r.status);
  return r.json();
}

/* ---------- render hourly tiles ---------- */
let selectedHourlyIdx = null;
function buildHourlyRow(times, temps, probs, codes){
  const row = el('hourlyRow'); row.innerHTML = '';
  for(let i=0;i<times.length;i++){
    const tile = document.createElement('div'); tile.className='hourly-tile'; tile.tabIndex=0;
    tile.dataset.idx = i;
    const timeLabel = (i===0) ? 'Now' : formatTime(times[i]);
    tile.innerHTML = `<div class="hourly-time">${timeLabel}</div><div class="hourly-icon">${wcIcon(codes[i])}</div><div class="hourly-temp">${Math.round(temps[i])}¬∞</div><div class="small muted">${probs[i]}%</div>`;
    tile.addEventListener('click', ()=> { selectHourly(i); });
    row.appendChild(tile);
  }
  // auto-select first tile
  selectHourly(0);
}
function selectHourly(i){
  const tiles = Array.from(document.querySelectorAll('.hourly-tile'));
  tiles.forEach(t=>t.classList.remove('selected'));
  const t = tiles[i]; if(t) t.classList.add('selected');
  selectedHourlyIdx = i;
  // optionally, we can display a little detail somewhere ‚Äî we'll scroll the charts to that index by updating tooltips
  // show a temporary popup by updating dayDetail small text
  const label = t ? t.querySelector('.hourly-time').innerText : '';
  const temp = t ? t.querySelector('.hourly-temp').innerText : '';
  const rain = t ? t.querySelector('.small').innerText : '';
  el('dayDetail').innerHTML = `<div style="font-weight:700">${label}</div><div class="small muted">${temp} ‚Ä¢ ${rain}</div>`;
}

/* ---------- render 5-day ---------- */
function renderDays(daily){
  const wrap = el('dayCards'); wrap.innerHTML = '';
  for(let i=0;i<daily.time.length;i++){
    const d = daily.time[i];
    const icon = wcIcon(daily.weathercode[i]);
    const hi = Math.round(daily.temperature_2m_max[i]||0), lo = Math.round(daily.temperature_2m_min[i]||0);
    const card = document.createElement('div'); card.className='day-card'; card.dataset.idx = i;
    card.innerHTML = `<div style="font-weight:700">${new Date(d).toLocaleDateString([], {weekday:'short'})}</div><div style="font-size:22px;margin-top:6px">${icon}</div><div style="margin-top:6px">${hi}¬∞ / ${lo}¬∞</div>`;
    card.addEventListener('click', ()=> { document.querySelectorAll('.day-card').forEach(c=>c.classList.remove('selected')); card.classList.add('selected'); showDayDetail(daily, i); });
    wrap.appendChild(card);
    if(i===0){ card.classList.add('selected'); showDayDetail(daily, 0); }
  }
}
function showDayDetail(daily,i){
  const html = `<div style="display:flex;gap:12px;align-items:center"><div style="font-size:34px">${wcIcon(daily.weathercode[i])}</div><div><div style="font-weight:700">${new Date(daily.time[i]).toLocaleDateString([], {weekday:'long', month:'short', day:'numeric'})}</div><div class="small muted">${daily.precipitation_sum ? 'Precip: '+Math.round(daily.precipitation_sum[i])+' mm':''}</div><div style="margin-top:8px">High: <b>${Math.round(daily.temperature_2m_max[i])}¬∞</b> ‚Ä¢ Low: <b>${Math.round(daily.temperature_2m_min[i])}¬∞</b></div></div></div>`;
  el('dayDetail').innerHTML = html;
}

/* ---------- small utility: set top summary icon + text ---------- */
function setSummary(icon, text){
  el('dayIcon').innerText = icon;
  el('daySummary').innerText = text;
}

/* ---------- main loader ---------- */
async function loadAll(lat=DEFAULT.lat, lon=DEFAULT.lon, label=DEFAULT.name){
  try{
    el('locName').innerText = label;
    centerMap(lat, lon, label);
    el('lastFetched')?.remove?.(); // not using separate last-fetched element to keep layout compact
    const om = await fetchOpenMeteo(lat, lon).catch(()=>null);
    if(!om) return alert('Forecast fetch failed');

    // hourly arrays
    const times = om.hourly.time || [];
    const temps = (om.hourly.temperature_2m || []).map(v=>Number(v));
    const probs = (om.hourly.precipitation_probability || []).map(v=>Math.round(v));
    const codes = (om.hourly.weathercode || []).map(v=>v);

    // find index nearest now
    const nowIdx = nearestIndexToNow(times);
    const count = Math.min(12, Math.max(6, times.length - nowIdx));
    const tTimes = times.slice(nowIdx, nowIdx+count), tTemps = temps.slice(nowIdx, nowIdx+count), tProbs = probs.slice(nowIdx, nowIdx+count), tCodes = codes.slice(nowIdx, nowIdx+count);

    // current = nearest
    const currentTemp = Math.round(temps[nowIdx]||tTemps[0]||0);
    el('currentTemp').innerText = `${currentTemp}¬∞`;

    // daily min/max
    const daily = om.daily || {};
    const high = daily.temperature_2m_max ? Math.round(daily.temperature_2m_max[0]) : Math.max(...tTemps.map(v=>Math.round(v)));
    const low  = daily.temperature_2m_min ? Math.round(daily.temperature_2m_min[0]) : Math.min(...tTemps.map(v=>Math.round(v)));
    el('highTemp').innerText = `${high}¬∞`; el('lowTemp').innerText = `${low}¬∞`;
    el('coords').innerText = `Lat: ${lat.toFixed(6)} ‚Ä¢ Lon: ${lon.toFixed(6)}`;

    // summary (avg next 6h)
    const next6 = probs.slice(nowIdx, nowIdx+6);
    const avg = next6.length ? Math.round(next6.reduce((a,b)=>a+b,0)/next6.length) : 0;
    let summary = '';
    if(avg>=60) summary = `High chance of rain (${avg}% avg next 6h)`;
    else if(avg>=30) summary = `Moderate chance of showers (${avg}% avg next 6h)`;
    else if(avg>0) summary = `Low chance of rain (${avg}% avg next 6h)`;
    else summary = `No rain expected in next 6 hours`;
    // pick icon from nearest hourly code or daily weathercode
    const icon = wcIcon(codes[nowIdx] || (daily.weathercode ? daily.weathercode[0] : 0));
    setSummary(icon, summary);

    // hourly row
    buildHourlyRow(tTimes, tTemps, tProbs, tCodes);

    // charts
    tempChart.data.labels = tTimes.map(t=>formatTime(t)); tempChart.data.datasets[0].data = tTemps; tempChart.update();
    precipChart.data.labels = tTimes.map(t=>formatTime(t)); precipChart.data.datasets[0].data = tProbs; precipChart.update();

    // 5-day
    if(daily && daily.time) renderDays(daily);

  } catch(e){
    console.error(e); alert('Error loading weather');
  }
}

/* ---------- geocoding ---------- */
async function geocode(q){
  const r = await fetch(GEO + encodeURIComponent(q) + '&count=5&language=en&format=json');
  if(!r.ok) return null;
  const j = await r.json(); return j.results && j.results.length ? j.results[0] : null;
}

/* ---------- events ---------- */
el('searchBtn').addEventListener('click', async ()=>{
  const q = el('searchBox').value.trim(); if(!q) return alert('Type a place'); 
  const res = await geocode(q); if(!res) return alert('Not found');
  const lab = `${res.name}${res.admin1? ', '+res.admin1 : ''}${res.country? ', '+res.country : ''}`;
  loadAll(res.latitude, res.longitude, lab);
});

el('preset').addEventListener('change', function(){
  const opt = this.selectedOptions[0]; if(!opt || !opt.dataset.lat) return;
  loadAll(Number(opt.dataset.lat), Number(opt.dataset.lon), opt.textContent);
});

el('setCoords').addEventListener('click', ()=>{
  const lat = parseFloat(el('latInput').value), lon = parseFloat(el('lonInput').value);
  if(isNaN(lat)||isNaN(lon)) return alert('Enter valid lat/lon');
  loadAll(lat, lon, `Lat:${lat.toFixed(6)}, Lon:${lon.toFixed(6)}`);
});

el('myLoc').addEventListener('click', ()=>{
  if(!navigator.geolocation) return alert('Geolocation not available');
  navigator.geolocation.getCurrentPosition(p=> loadAll(p.coords.latitude, p.coords.longitude, 'Your location'), ()=> alert('Location permission denied'));
});

el('snapshot').addEventListener('click', async ()=>{
  el('snapshot').disabled = true; el('snapshot').innerText = 'Preparing...';
  try{
    const canvas = await html2canvas(document.querySelector('.wrap'), {scale:2, backgroundColor:null});
    canvas.toBlob(b=>{ const url = URL.createObjectURL(b); const a = document.createElement('a'); a.href = url; a.download = 'weather-snapshot.png'; a.click(); URL.revokeObjectURL(url); }, 'image/png');
  }catch(e){ alert('Snapshot failed') } finally { el('snapshot').disabled=false; el('snapshot').innerText='üì∑ Snapshot' }
});

/* ---------- init ---------- */
loadAll(DEFAULT.lat, DEFAULT.lon, DEFAULT.name);
setInterval(()=> loadAll(), 10*60*1000);
</script>
</body>
</html>
