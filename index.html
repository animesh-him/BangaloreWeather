<!doctype html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Aerospace Park ‚Äî Weather Dashboard (Dark by default)</title>

<!-- Libraries -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<style>
  /* theme variables - dark-first but supports light */
  :root{
    /* Dark default values (so data-theme="dark" looks perfect) */
    --bg-from: #071017;
    --bg-to:   #081424;
    --page-text: #e6f0f8;
    --card-bg: #0f1720;
    --muted: #9aa6b2;
    --accent: #ff6b6b;
    --ok: #66e08b;
    --warn: #ffb86b;
    --bad: #ff8080;
    --card-shadow: 0 8px 30px rgba(0,0,0,0.6);
    --input-bg: rgba(20,26,32,0.6);
    --table-border: rgba(255,255,255,0.06);
    --map-border: rgba(255,255,255,0.06);
    --panel-contrast: rgba(255,255,255,0.03);
    --code-bg: rgba(255,255,255,0.02);
  }

  /* Light theme overrides (applied when data-theme="light") */
  [data-theme="light"]{
    --bg-from: #f7f9fc;
    --bg-to:   #f4f6f9;
    --page-text: #07101a;
    --card-bg: #ffffff;
    --muted: #556070;
    --accent: #b22222;
    --ok: #2e7d32;
    --warn: #ff9800;
    --bad: #d32f2f;
    --card-shadow: 0 8px 30px rgba(16,24,40,0.06);
    --input-bg: rgba(255,255,255,0.98);
    --table-border: rgba(16,24,40,0.05);
    --map-border: rgba(16,24,40,0.04);
    --panel-contrast: rgba(0,0,0,0.02);
    --code-bg: rgba(0,0,0,0.02);
  }

  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg-from),var(--bg-to));font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:var(--page-text)}
  .wrap{max-width:1000px;margin:18px auto;padding:12px}
  header{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  h1{margin:0;font-size:20px;color:var(--accent)}
  .subtitle{color:var(--muted);font-size:13px}
  .controls{margin-left:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap}

  input,select,button{
    padding:8px 10px;border-radius:8px;border:1px solid var(--panel-contrast);
    background:var(--input-bg);font-size:13px;color:var(--page-text);
  }
  button.primary{background:var(--accent);color:#fff;border:none}

  .grid{display:grid;grid-template-columns:1fr 380px;gap:14px;margin-top:14px}
  @media(max-width:980px){.grid{grid-template-columns:1fr}}
  .card{background:var(--card-bg);border-radius:12px;padding:12px;box-shadow:var(--card-shadow);color:var(--page-text)}
  .summary{display:flex;gap:12px;align-items:center}
  .icon{width:64px;height:64px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:26px;border:1px solid var(--panel-contrast);background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01))}
  .summary .text{flex:1}
  .small{font-size:13px;color:var(--muted)}
  .muted{color:var(--muted)}

  .charts{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
  @media(max-width:640px){.charts{grid-template-columns:1fr}}
  canvas{width:100%!important;height:160px!important;background:transparent}

  table{width:100%;border-collapse:collapse;margin-top:10px;color:var(--page-text);background:transparent}
  th,td{padding:8px;border:1px solid var(--table-border);text-align:left;font-size:13px;vertical-align:top}
  th{background:var(--panel-contrast);width:36%;font-weight:700}

  .warning{background: linear-gradient(90deg, rgba(255,80,80,0.12), rgba(255,80,80,0.06)); border-left:5px solid var(--bad); padding:10px; border-radius:8px; color:var(--page-text)}
  .no-warning{background: linear-gradient(90deg, rgba(60,180,100,0.06), rgba(60,180,100,0.03)); border-left:5px solid var(--ok); padding:10px; border-radius:8px; color:var(--ok)}

  #map{height:180px;border-radius:8px;margin-top:8px;border:1px solid var(--map-border)}
  .row{display:flex;gap:10px;align-items:center}
  .progress{height:12px;background:var(--panel-contrast);border-radius:99px;overflow:hidden;width:160px}
  .progress > i{display:block;height:100%;background:linear-gradient(90deg,#4fc3f7,#0288d1);width:0%}
  .toggle{cursor:pointer;padding:6px;border-radius:8px;border:1px solid var(--panel-contrast);background:var(--card-bg)}
  .hidden{display:none}
  code{background:var(--code-bg);padding:2px 6px;border-radius:6px}
  .small-muted {font-size:12px;color:var(--muted)}
</style>
</head>
<body>
  <div class="wrap" id="pageRoot" role="application">
    <header>
      <div>
        <h1>üå§ Aerospace Park ‚Äî Weather Dashboard</h1>
        <div class="subtitle">Open-Meteo forecasts ‚Ä¢ IMD advisory (via imd.json). Default: dark mode.</div>
      </div>

      <div class="controls" aria-hidden="false">
        <select id="preset" title="Quick presets">
          <option value="">Preset ‚Äî Aerospace Park (default)</option>
          <option data-lat="12.9896" data-lon="77.6387">Aerospace Park, Bangalore</option>
          <option data-lat="12.9716" data-lon="77.5946">Bengaluru (city)</option>
          <option data-lat="19.0760" data-lon="72.8777">Mumbai</option>
          <option data-lat="28.7041" data-lon="77.1025">New Delhi</option>
        </select>

        <input id="searchBox" placeholder="Search place (city or area)" aria-label="Search place" />
        <button id="searchBtn">Search</button>
        <button id="downloadBtn" class="toggle" title="Download dashboard PNG">üì∑ Snapshot</button>
        <button id="themeBtn" class="toggle" title="Toggle dark/light">üåì</button>
      </div>
    </header>

    <main class="grid" style="margin-top:14px">
      <!-- Left -->
      <section>
        <div id="dashboardCard" class="card" aria-live="polite">
          <div class="summary" id="topSummary">
            <div class="icon" id="weatherIcon">‚òÄÔ∏è</div>
            <div class="text">
              <div id="headline" style="font-weight:700;font-size:16px">Loading‚Ä¶</div>
              <div style="display:flex;gap:10px;align-items:center;margin-top:8px">
                <div class="small">Rain probability (next 1‚Äì3 hrs)</div>
                <div style="display:flex;gap:8px;align-items:center;flex:1">
                  <div class="progress" aria-hidden="true"><i id="probFill"></i></div>
                  <div id="probText" class="small muted" style="min-width:56px;text-align:right">‚Äî%</div>
                </div>
              </div>
              <div id="subnote" class="small muted" style="margin-top:8px"></div>
            </div>
          </div>

          <div class="charts">
            <div class="card" style="padding:10px;border-radius:10px">
              <div style="font-weight:700;margin-bottom:6px">Temperature (¬∞C)</div>
              <canvas id="tempChart" aria-label="Temperature chart"></canvas>
            </div>

            <div class="card" style="padding:10px;border-radius:10px">
              <div style="font-weight:700;margin-bottom:6px">Precipitation Probability (%)</div>
              <canvas id="precipChart" aria-label="Precip probability chart"></canvas>
            </div>
          </div>

          <div style="margin-top:12px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:700">Open-Meteo ‚Äî Next 6 hours</div>
              <div id="lastFetched" class="small-muted">Last: ‚Äî</div>
            </div>
            <div id="tableWrap" style="margin-top:8px"></div>
            <div id="sparkWrap" style="margin-top:10px" class="small-muted"></div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div style="font-weight:700">Map</div>
          <div id="map"></div>
          <div class="small-muted" style="margin-top:8px">Click map to center marker. Drag marker to update location.</div>
        </div>
      </section>

      <!-- Right -->
      <aside>
        <div class="card hidden" id="imdCard">
          <div style="font-weight:700">IMD Advisory</div>
          <div id="imdBox" style="margin-top:8px"></div>
          <div id="imdNote" class="small-muted" style="margin-top:8px"></div>
        </div>

        <div class="card" style="margin-top:12px">
          <div style="font-weight:700">Actions</div>
          <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
            <button id="refreshBtn">Refresh now</button>
            <div class="small-muted" style="margin-left:auto">Auto-refresh every 10m</div>
          </div>
        </div>
      </aside>
    </main>
  </div>

<script>
/* ---------- Config & helpers ---------- */
const DEFAULT = { name: "Aerospace Park, Bangalore", lat: 12.9896, lon: 77.6387 };
const OPEN_METEO = "https://api.open-meteo.com/v1/forecast";
const GEO = "https://geocoding-api.open-meteo.com/v1/search?name=";
let current = {...DEFAULT};
const el = id => document.getElementById(id);
function escapeHtml(s){return (s||'').toString().replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}
function nowLocale(ts){ try { const d = new Date(ts); return d.toLocaleString(); } catch(e){ return ts; } }

/* ---------- Theme: default dark, toggle persists ---------- */
const root = document.documentElement;
const themeBtn = el('themeBtn');
const savedTheme = localStorage.getItem('theme');
if(savedTheme === 'light') root.setAttribute('data-theme','light'); else root.setAttribute('data-theme','dark');
themeBtn.addEventListener('click', ()=> {
  if(root.getAttribute('data-theme') === 'dark'){ root.setAttribute('data-theme','light'); localStorage.setItem('theme','light'); }
  else { root.setAttribute('data-theme','dark'); localStorage.setItem('theme','dark'); }
});

/* ---------- Charts ---------- */
const tempCtx = el('tempChart').getContext('2d');
const precipCtx = el('precipChart').getContext('2d');
const tempChart = new Chart(tempCtx, {
  type:'line',
  data:{labels:[], datasets:[{label:'Temp ¬∞C', data:[], borderColor:'#ff8a65', backgroundColor:'rgba(255,138,101,0.12)', tension:0.3, fill:true}]},
  options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}
});
const precipChart = new Chart(precipCtx, {
  type:'bar',
  data:{labels:[], datasets:[{label:'Rain %', data:[], backgroundColor:'rgba(69,170,242,0.7)'}]},
  options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,max:100}}}
});

/* ---------- Map (Leaflet) ---------- */
const map = L.map('map', {center:[DEFAULT.lat, DEFAULT.lon], zoom:13, attributionControl:false});
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
const marker = L.marker([DEFAULT.lat, DEFAULT.lon], {draggable:true}).addTo(map).bindPopup(DEFAULT.name).openPopup();
marker.on('dragend', function(){ const p = marker.getLatLng(); current.lat = p.lat; current.lon = p.lng; loadAll(current.lat, current.lon, `Lat:${p.lat.toFixed(4)}, Lon:${p.lng.toFixed(4)}`); });
map.on('click', e => { marker.setLatLng(e.latlng); map.panTo(e.latlng); current.lat = e.latlng.lat; current.lon = e.latlng.lng; loadAll(current.lat, current.lon, `Lat:${current.lat.toFixed(4)}, Lon:${current.lon.toFixed(4)}`); });

/* ---------- Fetch functions ---------- */
async function fetchOpenMeteo(lat, lon){
  const params = new URLSearchParams({
    latitude: lat, longitude: lon,
    hourly: 'temperature_2m,precipitation,precipitation_probability,windspeed_10m',
    daily: 'sunrise,sunset',
    timezone: 'auto'
  });
  const url = OPEN_METEO + '?' + params.toString();
  const r = await fetch(url);
  if(!r.ok) throw new Error('Open-Meteo error ' + r.status);
  return r.json();
}
async function loadIMDJson(){
  try {
    const r = await fetch('./imd.json?_=' + Date.now());
    if(!r.ok) return null;
    return r.json();
  } catch(e){ return null; }
}

/* ---------- Advisory heading extraction ---------- */
function makeHeading(sentence){
  if(!sentence || typeof sentence !== 'string') return 'Advisory';
  // prefer splitting at colon or dash if present
  let s = sentence.trim();
  const parts = s.split(/[:\-‚Äî]/);
  if(parts.length>1 && parts[0].trim().length>3) return parts[0].trim().slice(0,60);
  const words = s.split(/\s+/).slice(0,4).join(' ');
  return words.length > 40 ? words.slice(0,37)+'...' : words;
}

/* ---------- Render advisory table & hide when empty ---------- */
function renderIMDTable(imdData){
  const card = el('imdCard'); const box = el('imdBox');
  if(!imdData || !imdData.imd_bengaluru){ card.classList.add('hidden'); return; }
  const warnings = Array.isArray(imdData.imd_bengaluru.warnings) ? imdData.imd_bengaluru.warnings.filter(Boolean) : [];
  if(warnings.length === 0){ card.classList.add('hidden'); return; }
  let html = '<table aria-label="IMD advisory table"><tbody>';
  warnings.forEach(w => {
    const heading = makeHeading(w);
    html += `<tr><th>${escapeHtml(heading)}</th><td>${escapeHtml(w)}</td></tr>`;
  });
  html += '</tbody></table>';
  box.innerHTML = html;
  el('imdNote').innerText = `Source: IMD via imd.json ‚Ä¢ Updated: ${imdData.fetched_at || '‚Äî'}`;
  card.classList.remove('hidden');
}

/* ---------- Render forecast and charts ---------- */
function renderTable(om){
  const times = om.hourly?.time || [];
  const temps = om.hourly?.temperature_2m || [];
  const prec = om.hourly?.precipitation || [];
  const prob = om.hourly?.precipitation_probability || [];
  const wind = om.hourly?.windspeed_10m || [];
  const rows = Math.min(6, times.length);
  if(rows===0){ el('tableWrap').innerText='No forecast data.'; return; }
  let html = '<table aria-label="Forecast table"><thead><tr><th style="width:36%">Time</th><th>Temp</th><th>Rain mm</th><th>Rain %</th><th>Wind m/s</th></tr></thead><tbody>';
  for(let i=0;i<rows;i++){
    html += `<tr><td>${escapeHtml(times[i])}</td><td>${temps[i] ?? '‚Äî'}</td><td>${prec[i] ?? '‚Äî'}</td><td>${prob[i] ?? '‚Äî'}</td><td>${wind[i] ?? '‚Äî'}</td></tr>`;
  }
  html += '</tbody></table>';
  el('tableWrap').innerHTML = html;
}
function updateCharts(om){
  const labels = (om.hourly?.time || []).slice(0,12).map(t => t.replace('T',' '));
  const temps = (om.hourly?.temperature_2m || []).slice(0,12);
  const probs = (om.hourly?.precipitation_probability || []).slice(0,12).map(v=>Number(v||0));
  tempChart.data.labels = labels; tempChart.data.datasets[0].data = temps; tempChart.update();
  precipChart.data.labels = labels; precipChart.data.datasets[0].data = probs; precipChart.update();
}
function computeProbSummary(om){
  const probs = om.hourly?.precipitation_probability || [];
  const n = Math.min(3, probs.length);
  if(n===0) return {avg:0,n:0};
  let s=0; for(let i=0;i<n;i++) s+=Number(probs[i]||0);
  return {avg: Math.round(s/n), n};
}

/* ---------- Main loader ---------- */
async function loadAll(lat=current.lat, lon=current.lon, pretty=current.name){
  try {
    el('headline').innerText = `Loading data for ${pretty}‚Ä¶`;
    const [omPromise, imdPromise] = [fetchOpenMeteo(lat, lon).catch(e=>null), loadIMDJson().catch(e=>null)];
    const [omVal, imdVal] = await Promise.all([omPromise, imdPromise]);

    if(omVal){
      renderTable(omVal); updateCharts(omVal);
      const {avg,n} = computeProbSummary(omVal);
      el('probFill').style.width = avg + '%'; el('probText').innerText = avg + '%';
      let headline = 'No rain expected in next ' + n + ' hr' + (n>1?'s':'');
      let icon='‚òÄÔ∏è';
      if(avg>=60){ headline='High chance of rain'; icon='üåßÔ∏è'; }
      else if(avg>=30){ headline='Moderate chance of showers'; icon='‚õÖ'; }
      else if(avg>0){ headline='Low chance of rain'; icon='üå§Ô∏è'; }
      el('headline').innerText = headline; el('weatherIcon').innerText = icon;
      el('subnote').innerText = `Precip prob averaged over next ${n} hour${n>1?'s':''}.`;
      el('lastFetched').innerText = 'Last: ' + (imdVal?.fetched_at ?? new Date().toISOString());
      marker.setLatLng([lat,lon]); marker.bindPopup(pretty).openPopup(); map.setView([lat,lon],13);
    } else {
      el('headline').innerText = 'No forecast available';
      el('tableWrap').innerText = 'Forecast fetch failed.';
    }

    renderIMDTable(imdVal);
    if(omVal?.hourly?.temperature_2m){
      const temps = omVal.hourly.temperature_2m.slice(0,12);
      const avgTemp = Math.round(temps.reduce((a,b)=>a+(b||0),0)/temps.length);
      el('sparkWrap').innerText = `Avg (next 12 hrs): ${avgTemp} ¬∞C ‚Ä¢ Times shown in API timezone`;
    } else el('sparkWrap').innerText = '';
    current = {name: pretty, lat, lon};
  } catch(e){
    console.error(e);
    el('headline').innerText = 'Error loading data';
    el('imdBox').innerText = 'Error loading advisory';
  }
}

/* ---------- Geocode (search) ---------- */
async function geocode(q){
  const r = await fetch(GEO + encodeURIComponent(q) + '&count=5&language=en&format=json');
  if(!r.ok) return null;
  const j = await r.json();
  return j.results && j.results.length ? j.results[0] : null;
}

/* ---------- Events ---------- */
el('searchBtn').addEventListener('click', async ()=>{
  const q = el('searchBox').value.trim(); if(!q) return alert('Type place name');
  const res = await geocode(q); if(!res) return alert('No place found');
  const pretty = `${res.name}${res.admin1? ', '+res.admin1 : ''}${res.country? ', '+res.country : ''}`;
  await loadAll(res.latitude, res.longitude, pretty);
});

el('preset').addEventListener('change', async function(){
  const opt = this.selectedOptions[0]; if(!opt || !opt.dataset.lat) return;
  const lat = Number(opt.dataset.lat), lon = Number(opt.dataset.lon), pretty = opt.textContent;
  await loadAll(lat, lon, pretty);
});

el('refreshBtn').addEventListener('click', ()=> loadAll(current.lat, current.lon, current.name));

/* ---------- Download (html2canvas) ---------- */
el('downloadBtn').addEventListener('click', async ()=>{
  const node = el('dashboardCard');
  el('downloadBtn').disabled = true; el('downloadBtn').innerText = 'Preparing...';
  try {
    const canvas = await html2canvas(node, {scale:2, backgroundColor: null});
    canvas.toBlob((blob)=>{
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url;
      a.download = `weather-${(new Date()).toISOString().slice(0,19)}.png`;
      a.click(); URL.revokeObjectURL(url);
    }, 'image/png');
  } catch(e){
    alert('Snapshot not supported in this browser.');
  } finally {
    el('downloadBtn').disabled = false; el('downloadBtn').innerText = 'üì∑ Snapshot';
  }
});

/* ---------- Init ---------- */
(async function init(){
  await loadAll(DEFAULT.lat, DEFAULT.lon, DEFAULT.name);
  setInterval(()=> loadAll(current.lat, current.lon, current.name), 10*60*1000);
})();
</script>
</body>
</html>
